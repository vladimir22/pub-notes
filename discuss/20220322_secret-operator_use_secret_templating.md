
## The Problem:
Some applications like [infinispan-operator](https://infinispan.org/docs/infinispan-operator/main/operator.html#assigning-user-roles_authorization) keep ALL the credentials under the single `Secret` key, example:

```yaml
##  -------------- Cluster Side --------------
kubectl apply -n infinispan -f - <<EOF
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: $CLUSTER_NAME-identities
stringData:
  identities.yaml: |- 
    credentials:
      - username: appuser
        password: appuser123
        roles:
          - dev
      - username: operator
        password: admin
        roles:
          - admin
    
EOF
```

In a same time, Client's `Secret` object contains only single client username and password:
```yaml
##  -------------- Client Side --------------
kubectl apply -n $ECHOSERVER_NS -f - <<EOF
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: $CACHE_NAME-auth
stringData:
  username: appuser
  password: appuser123

  conjur-map: |-
    username: pfAuthID-demo-secret1/cache_username
    password: pfAuthID-demo-secret1/cache_password
EOF
```
How to set up variables in the `External Secret Management System (Conjur OSS)` for these cases?
It is possible to keep multiple variables with dupplicated content (for this example: "identities.yaml", "cache1_username", "cache1_password", "cache2_username", "cache2_password", etc.) that is inconvenient from customers side.


## The Idea:
Provide "customer-oriented" solution which allows to keep client `username` and `password` values as a dedicated single variable in the External Secret Management System.  
`Secret Operator` knows how to generate necessary `Secret` key content (`identities.yaml` content) by provided template.


## The Deatils of Implementation:
#### - Introduce `template` section in the `SecretManager` CRD
```yaml
kubectl apply -n $ECHOSERVER_NS -f - <<EOF
apiVersion: secretoperator.security.grid.digital.ge.com/v1beta1
kind: SecretManager
metadata:
  name: infinispan-cluster
spec:
  secretProvider: conjur-demo ## by provider type the custom logic will be selected and applied

  selector:
    matchLabels:
      app: infinispan-cluster

  secrets:
    - name: $CLUSTER_NAME-identities
      mapping:
        - key: cache_username
          externalKey: pfAuthID-demo-secret1/cache_username
        - key: cache_password
          externalKey: pfAuthID-demo-secret1/cache_password
        - key: admin_username
          externalKey: pfAuthID-demo-secret1/admin_username
        - key: admin_password
          externalKey: pfAuthID-demo-secret1/admin_password

      template: ## conains secret key and template for the  "$CLUSTER_NAME-identities" secret
        - key: identities.yaml
          value: |- 
            credentials:
              - username: {{ .cache_username }}
                password: {{ .cache_password }}
                roles:
                  - dev
              - username: {{ .admin_username }}
                password: {{ .admin_password }}
                roles:
                  - admin
EOF
```
#### - If `template` section is defined `SecretOperator` will create "Annotated Intermediate Secret" with `conjur-map` data inside:
```yaml
kubectl apply -n infinispan -f - <<EOF
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: $CLUSTER_NAME-identities-template
  annotanions:
    ## SecretOperator watches for this secret update and recreate $CLUSTER_NAME-identities
    secretoperator.security.grid.digital.ge.com/template-for-secret-key: $CLUSTER_NAME-identities/identities.yaml
    
stringData:
  conjur-map: |-
    cache_username: pfAuthID-demo-secret1/cache_username
    cache_password: pfAuthID-demo-secret1/cache_password
    admin_username: pfAuthID-demo-secret1/admin_username
    admin_password: pfAuthID-demo-secret1/admin_password

  cache_username: <<value_UPDATED>>
  cache_password: <<value_UPDATED>>
  admin_username: <<value_UPDATED>>
  admin_password: <<value_UPDATED>>

  identities.yaml: |- 
    credentials:
      - username: {{ .cache_username }}
        password: {{ .cache_password }}
        roles:
          - dev
      - username: {{ .admin_username }}
        password: {{ .admin_password }}
        roles:
          - admin
EOF
```

#### - `SecretOperator` watches and reconciles Update Events from "Annotated Intermediate Secret".
Result of Update Events Reconciliation logic it is updated `Secret` key content ($CLUSTER_NAME-identities/identities.yaml) that was generated by provided GO template, example:

```yaml
kubectl apply -n infinispan -f - <<EOF
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: $CLUSTER_NAME-identities
stringData:
  identities.yaml: |- 
    credentials:
      - username: appuser_UPDATED
        password: appuser123_UPDATED
        roles:
          - dev
      - username: operator_UPDATED
        password: admin_UPDATED
        roles:
          - admin
EOF
```

## Achivable Result:
`External Secret Management System (Conjur OSS)` keeps variables which are unique and not dupplicated ( "admin_username", "admin_password", "cache1_username", "cache1_password", etc.)
`Secret Operator` knows how to use these variables to generate necessary `Secret` key content ("identities.yaml") by specified template


